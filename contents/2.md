### XSS

- XSS 是 Cross Site Scripting 跨站脚本攻击的意思，X是英文Cross的简称
- 什么叫做跨站，就是非自己网站，如果本网站运行了来自别的网站的东西就叫做XSS
- 举个例子，如下是前端页面代码
    ```html
    <!-- pug模板引擎语法 -->
    if from
        span -- 欢迎来自!{from}的朋友
    ```
- 下面是后端逻辑代码
    ```js
    // from 来源于get参数
    ctx.render('index', {posts, comments, from:ctx.query.from || ''});
    ```
- 现在，如果我们在页面url上加上如下代码 `?from=<script>alert(1)</script>`
- 可以看到页面弹出1，这就是一段XSS攻击代码，为什么是跨站攻击呢？我们可以做如下变通
    * `?from=<script src='其他网站的脚本.js'></script>`
- 这种跨站脚本可以执行任何形式的攻击，其攻击原理是：程序+数据=结果
- 当我们的数据中包含一部分程序的时候，原来我们程序的逻辑就会被改变了
- 页面中的脚本可以干什么，XSS的脚本就可以看什么，比如
    * 获取页面数据
    * 获取Cookie
    * 劫持前端逻辑
    * 发送请求
    * 偷取网站任意数据资料，密码，登录态
    * 欺骗用户
    * ...
- 可见XSS是一种非常危险的前端攻击手段
- 常见的XSS攻击案例
    * 站酷的搜索框
    * QQ空间的富文本编辑器，script脚本侧漏
    * 电商表单提交脚本，在后台页面运行，获取后台地址和登录态

### XSS攻击的分类

- XSS攻击的种类很多，尤其是变种很多，我们可以按照攻击代码的来源分为两种
- 1 ) 反射型：url参数直接注入, 危害略小
    * 攻击者一般会把这种参数变换，比如做一个短网址，在dwz.cn中变换为短网址
    * 一般受害者可能会忽略误点从而导致受害
    * 反射型攻击可以和其他攻击结合进而自动传播
- 2 ) 存储型：存储到DB后读取时注入，攻击代码来自网站数据，危害较大
    * 一般通过富文本编辑器将脚本注入数据库中
    * 当用户浏览到注入脚本数据的页面时，就会中招

### XSS攻击注入点

- HTML节点内容：如果内容是动态生成了，包含用户输入，那么这个输入中可能包含脚本，进而导致XSS攻击
    * 比如程序是这样的：`<div>#{content}</div>`, 但是可能会变成这样：`<div><script>...</script></div>`
    * 主要是存储型XSS攻击，内容提交后注入
- HTML属性：某个HTML节点的某一个属性是由用户输入构成的，用户输入数据有可能包含脚本或者越出属性本身的范围导致XSS攻击
    * 比如原先是这样的`<img src="#{image}" />`，结果却成了这样`<img src="1" onerror="alert(1)" />`
    * 具体程序程序比如前端是这样做的
        ```html
        <!-- pug模板引擎 -->
        if avatarId
            <img src="/image/!{avatarId}" />
        ```
    * 后端是这样的
        ```js
        // 同样是通过某种参数来引用的
        ctx.render('index', {avatarId:ctx.query.avatarId || ''});
        ```
    * 只需要在url中这样访问即可：`?avatarId=1" onerror="alert(1)` 此时产生一个onerror的新属性
    * 这时候就会执行其中的脚本，这明显是一种反射型攻击
- js代码：存在由后台注入的变量，或里面包含用户输入的信息，有可能用户输入信息会改变js代码的逻辑导致XSS攻击
    * 原本逻辑是这样的`var data = "#{data}";`, 结果却成了 `var data = "hello";alert(1);"";`
    * 这里的data来自服务器的数据，这个数据很可能是之前用户输入的，也就是用户提前将这个变量进行了关闭
    * 这时候原本的一句代码变成了3句代码，这种可以是反射型攻击，也可能是存储型攻击
- 富文本：富文本是一大段的HTML标签，我们要保留html格式也要小心其中可能包含XSS攻击的代码
    * 以QQ邮箱为例，可以设置任意的格式，本质上是一段复杂的html
    * 富文本会保留HTML, 但是HTML具有XSS攻击的风险

### XSS常见的防御方案

- 浏览器自带防御：参数出现在HTML内容或属性中，浏览器会自行拦截并提示: `ERR_BLOCKED_BY_XSS_AUDITOR`
    * 如果发现谷歌浏览器等现代浏览器没有进行拦截，可能是我们设置了取消拦截
    * 如 `ctx.set('X-XSS-Protection', 0)` 具体有三种参数
    * 第一种是 0 是关闭保护
    * 第二种是 1 是默认开启
    * 第三种是1后面再加一个url参数，谷歌浏览器会向这个url发送一个通知
    * 它防御范围非常有限，即反射型XSS攻击，而且只防御HTML相关的注入(内容或属性)
    * 而在js中注入的参数不会被拦截, 如 url: `?from=";alert(document.cookie);"`, js脚本：`var from = "!{from}";`